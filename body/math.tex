\pagenumbering{arabic}
\section{数学基础}
\subsection{位姿及其表示方式}

\subsection{刚体运动}

\subsection{B样条}
\subsubsection{B样条标准基本形式}
B样条(B-Spline)\cite{geneva2018research}由一系列控制点(也被称为“结点”)组成。由控制点定义的基函数的线性组合来表示连续函数。以平移为例，$t$时刻的平移$\mathbf{p}(t)$用样条表示为，
\begin{equation}
	\mathbf{p}(t)=\sum_{i=0}^N b_{i, k}(t) \mathbf{p}_i 
\end{equation}
其中，$N$是控制点的个数，$k$是样条的阶数，$b_{i, k}(t)$由De Boor-Cox递归公式\cite{de1978practical}定义，
\begin{equation}
	b_{i, 0}(t):= \begin{cases}1 & \text { if } \quad t_i \leq t<t_{i+1} \\ 0 & \text { otherwise }\end{cases}
\end{equation}
\begin{equation}
	b_{i, k}(t):=\frac{t-t_i}{t_{i+k}-t_i} b_{i, k-1}(t)+\frac{t_{i+k+1}-t}{t_{i+k+1}-t_{i+1}} b_{i+1, k-1}(t)
\end{equation}

\subsubsection{均匀B样条标准基本矩阵形式}
均匀B样条是B样条的一种特殊情形，即任意相邻控制点的时间之差相等，
\begin{equation}
	u(t)=\frac{t-t_i}{t_{i+1}-t_i}=\frac{t-t_i}{\Delta t}, u \in[0,1)
\end{equation}
根据\cite{qin1998general}，De Boor-Cox递归形式可以转化为矩阵相乘，即
\begin{equation}
	\mathbf{p}(t)=\mathbf{b}(u(t))\left[\begin{array}{c}
		\mathbf{p}_0^{\top} \\
		\vdots \\
		\mathbf{p}_i^{\top} \\
		\vdots \\
		\mathbf{p}_n^{\top}
	\end{array}\right]=\left[\begin{array}{lllll}
		1 & \cdots & u(t)^i & \cdots & u(t)^{k-1}
	\end{array}\right] \mathbf{M}^k\left[\begin{array}{c}
		\mathbf{p}_0^{\top} \\
		\vdots \\
		\mathbf{p}_i^{\top} \\
		\vdots \\
		\mathbf{p}_n^{\top}
	\end{array}\right]
\end{equation}
其中，
\begin{equation}
	\mathbf{M}^k=\left[\begin{array}{cccc}
		m_{0,0} & m_{0,1} & \cdots & m_{0, n} \\
		m_{1,0} & m_{1,1} & \cdots & m_{1, n} \\
		\vdots & \vdots & \ddots & \vdots \\
		m_{k-1,0} & m_{k-1,1} & \cdots & m_{k-1, n}
	\end{array}\right]_{k \times n}
\end{equation}
\begin{equation}
	m_{i, j}=\frac{1}{(k-1) !} \mathbf{C}_{k-1}^{k-1-i} \sum_{s=j}^{k-1}\left[(-1)^{s-j} \mathbf{C}_k^{s-j}(k-s-1)^{k-1-i}\right]
\end{equation}
\begin{equation}
	\mathbf{C}_n^i=\frac{n !}{i !(n-i) !}
\end{equation}
标准形式的表示的B样条存在不连续的问题。因此，对于位姿而言，将轨迹表示成累计基本形式B样条更好，即
\begin{equation}
	\mathbf{p}(t)=\tilde{b}_{0, k}(t) \mathbf{p}_0 +\sum_{i=1}^n \tilde{b}_{i, k}(t) \left(\mathbf{p}_i-\mathbf{p}_{i-1}\right) 
\end{equation}
\begin{equation}
	\tilde{b}_{i, k}(t)=\sum_{s=i}^n b_{s, k}(t)
\end{equation}
\subsubsection{均匀B样条累计基本矩阵形式}
当相邻控制点的时间之差相等时，相邻控制点的时间之差相等为，
\begin{equation}
	\mathbf{p}(t)=\tilde{\mathbf{b}}(u(t))\left[\begin{array}{c}
		\mathbf{p}_0^{\top} \\
		\vdots \\
		\mathbf{p}_i^{\top} \\
		\vdots \\
		\mathbf{p}_n^{\top}
	\end{array}\right]=\left[\begin{array}{lllll}
		1 & \cdots & u(t)^i & \cdots & u(t)^{k-1}
	\end{array}\right] \tilde{\mathbf{M}}^k\left[\begin{array}{c}
		\mathbf{p}_0^{\top} \\
		\vdots \\
		\mathbf{p}_i^{\top} \\
		\vdots \\
		\mathbf{p}_n^{\top}
	\end{array}\right]
\end{equation}
其中，
\begin{equation}
	\tilde{\mathbf{M}}^k=\left[\begin{array}{cccc}
		\sum\limits_{s=0}^{n-1} m_{0, s} & \sum\limits_{s=1}^{n-1} m_{0, s} & \cdots & \sum\limits_{s=n-1}^{n-1} m_{0, s} \\
		\sum\limits_{s=0}^{n-1} m_{1, s} & \sum\limits_{s=1}^{n-1} m_{1, s} & \cdots & \sum\limits_{s=n-1}^{n-1} m_{1, s} \\
		\vdots & \vdots & \ddots & \vdots \\
		\sum\limits_{s=0}^{n-1} m_{k-1, s} & \sum\limits_{s=1}^{n-1} m_{k-1, s} & \cdots & \sum\limits_{s=n-1}^{n-1} m_{k-1, s}
	\end{array}\right]_{k \times n}
\end{equation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{均匀B样条表示轨迹}
假设位姿表示为，
\begin{equation}
	{ }_s^w \mathbf{T}=\left[\begin{array}{cc}
		{ }_s^w \mathbf{R} & { }^w \mathbf{p}_s \\
		\mathbf{0} & 1
	\end{array}\right], \quad{ }_s^w \mathbf{T} \in \mathbb{S E}(3), \quad{ }_s^w \mathbf{R} \in \mathbb{S O}(3)
\end{equation}
假设位姿的速度和角速度是恒定的，利用矩阵的指数变换和对数变换，均匀B样条定义为，
\begin{equation}
	{ }_s^w \mathbf{T}(t)=\exp \left(\tilde{b}_{0, k}(t) \log \left({ }_s^w \mathbf{T}_0\right)\right) \prod_{i=1}^n \exp \left(\tilde{b}_{i, k}(t) \log \left({ }_s^w \mathbf{T}_{i-1}^{-1} {_s^w}\mathbf{T}_i\right)\right)
\end{equation}
改方式样条定义期望具有以下性质，
\begin{itemize}
	\item 局部控制性，即允许系统以在线或者批量的形式运行
	\item 二阶连续性，以保证能够二次微分得到加速度
	\item 能够较好的近似最小关节力矩轨迹
	\item 对于刚体运动没有奇异值
\end{itemize}
累计基本形式的三次B样条满足上述性质，即
\begin{equation}
	{ }_s^w \mathbf{T}(t)=\exp \left(\tilde{B}_{0,4}(t) \log \left({ }_{i-1}^w \mathbf{T}\right)\right) \prod_{i=1}^3 \exp \left(\tilde{B}_{i, 4}(t) \log \left({ }_{i-1}^w \mathbf{T}^{-1}{ }_i^w \mathbf{T}\right)\right)
\end{equation}
展开为，
\begin{equation}\label{equ:cubic-bspline-pose}
	\begin{aligned}
		& { }_s^w \mathbf{T}(t)=\exp \left(\tilde{B}_{0,4}(t) \log \left({ }_{i-1}^w \mathbf{T}\right)\right) \exp \left(\tilde{B}_{1,4}(t) \log \left({ }_{i-1}^w \mathbf{T}^{-1}{ }_i^w \mathbf{T}\right)\right) \\
		& \quad \exp \left(\tilde{B}_{2,4}(t) \log \left({ }_i^w \mathbf{T}^{-1}{ }_{i+1}^w \mathbf{T}\right)\right) \exp \left(\tilde{B}_{3,4}(t) \log \left({ }_{i+1}^w \mathbf{T}^{-1}{ }_{i+2}^w \mathbf{T}\right)\right)
	\end{aligned}
\end{equation}
其累计矩阵形式为，
\begin{equation}\label{equ:bspline-basis}
	\begin{aligned}
		\tilde{\mathbf{B}}(u(t)) & =\left[\begin{array}{lllll}
			1 & \cdots & u(t)^i & \cdots & u(t)^{4-1}
		\end{array}\right] \tilde{\mathbf{M}}^4 \\
		& =\left[\begin{array}{llll}
			1 & u & u^2 & u^3
		\end{array}\right]\left[\begin{array}{llll}
			\sum\limits_{s=0}^{4-1} m_{0, s} & \sum\limits_{s=1}^{4-1} m_{0, s} & \sum\limits_{s=2}^{4-1} m_{0, s} & \sum\limits_{s=3}^{4-1} m_{0, s} \\
			\sum\limits_{s=0}^{4-1} m_{1, s} & \sum\limits_{s=1}^{4-1} m_{1, s} & \sum\limits_{s=2}^{4-1} m_{1, s} & \sum\limits_{s=3}^{4-1} m_{1, s} \\
			\sum\limits_{s=0}^{4-1} m_{2, s} & \sum\limits_{s=1}^{4-1} m_{2, s} & \sum\limits_{s=2}^{4-1} m_{2, s} & \sum\limits_{s=3}^{4-1} m_{2, s} \\
			\sum\limits_{s=0}^{4-1} m_{3, s} & \sum\limits_{s=1}^{4-1} m_{3, s} & \sum\limits_{s=2}^{4-1} m_{3, s} & \sum\limits_{s=3}^{4-1} m_{3, s}
		\end{array}\right]_{4 \times 4} \\
		& =\frac{1}{3 !}\left[\begin{array}{llll}
			1 & u & u^2 & u^3
		\end{array}\right]\left[\begin{array}{cccc}
			6 & 5 & 1 & 0 \\
			0 & 3 & 3 & 0 \\
			0 & -3 & 3 & 0 \\
			0 & 1 & -2 & 1
		\end{array}\right]_{4 \times 4} \\
		& =\frac{1}{3 !}\left[\begin{array}{lllll}
			6 & \left(5+3 u-3 u^2+u^3\right) & \left(1+3 u+3 u^2-2 u^3\right) & u^3
		\end{array}\right]_{1 \times 4}
	\end{aligned}
\end{equation}
代入公式(\ref{equ:cubic-bspline-pose})得到，
\begin{equation}\label{equ:cubic-bspline-pose-expand}
	\begin{aligned}
		{ }_s^w \mathbf{T}(u(t))&= \exp \left(\frac{1}{6}(6) \log \left({ }_{i-1}^w \mathbf{T}\right)\right) \exp \left(\frac{1}{6}\left(5+3 u-3 u^2+u^3\right) \log \left({ }_{i-1}^w \mathbf{T}^{-1}{ }_i^w \mathbf{T}\right)\right) \\
		& \exp \left(\frac{1}{6}\left(1+3 u+3 u^2-2 u^3\right) \log \left({ }_i^w \mathbf{T}^{-1}{ }_{i+1}^w \mathbf{T}\right)\right) \exp \left(\frac{1}{6} u^3 \log \left({ }_{i+1}^w \mathbf{T}^{-1}{ }_{i+2}^w \mathbf{T}\right)\right) \\
		&=\exp \left(\log \left({ }_{i-1}^w \mathbf{T}\right)\right) \exp \left(\frac{1}{6}\left(5+3 u-3 u^2+u^3\right) \log \left({ }_i^{i-1} \mathbf{T}\right)\right) \\
		& \quad \exp \left(\frac{1}{6}\left(1+3 u+3 u^2-2 u^3\right) \log \left({ }_{i+1}^i \mathbf{T}\right)\right) \exp \left(\frac{1}{6} u^3 \log \left({ }_{i+2}^{i+1} \mathbf{T}\right)\right)
	\end{aligned}
\end{equation}
\subsubsection{B样条微分}
公式(\ref{equ:cubic-bspline-pose-expand})可以简化为，
\begin{equation}
	\begin{aligned}
		{ }_s^w \mathbf{T}(u(t)) & ={ }_{i-1}^w \mathbf{T} \exp \left(B_0(u(t)){ }_i^{i-1} \boldsymbol{\Omega}\right) \exp \left(B_1(u(t)){ }_{i+1}^i \boldsymbol{\Omega}\right) \exp \left(B_2(u(t)){ }_{i+2}^{i+1} \boldsymbol{\Omega}\right) \\
		& ={ }_{i-1}^w \mathbf{T} \mathbf{A}_0 \mathbf{A}_1 \mathbf{A}_2
	\end{aligned}
\end{equation}
根据乘法链式法则并注意${ }_s^w \mathbf{T}_i$与时间$t$无关，则对时间$t$求一阶导得到，
\begin{equation}
	\frac{\partial}{\partial t}{ }_s^w \mathbf{T}(u(t))={ }_s^w \mathbf{T}_{i-1}\left(\dot{\mathbf{A}}_0 \mathbf{A}_1 \mathbf{A}_2+\mathbf{A}_0 \dot{\mathbf{A}}_1 \mathbf{A}_2+\mathbf{A}_0 \mathbf{A}_1 \dot{\mathbf{A}}_2\right)
\end{equation}
对时间$t$求二阶导得到，
\begin{equation}
	\begin{aligned}
		& \frac{\partial}{\partial t^2}{ }_s^w \mathbf{T}(u(t))={ }_s^w \mathbf{T}_{i-1}\left(\ddot{\mathbf{A}}_0 \mathbf{A}_1 \mathbf{A}_2+\mathbf{A}_0 \ddot{\mathbf{A}}_1 \mathbf{A}_2+\mathbf{A}_0 \mathbf{A}_1 \ddot{\mathbf{A}}_2\right. \\
		&\left.+2 \dot{\mathbf{A}}_0 \dot{\mathbf{A}}_1 \mathbf{A}_2+2 \mathbf{A}_0 \dot{\mathbf{A}}_1 \dot{\mathbf{A}}_2+2 \dot{\mathbf{A}}_0 \mathbf{A}_1 \dot{\mathbf{A}}_2\right)
	\end{aligned}
\end{equation}
以$\mathbf{A}_0$为例，讲述如何求得一阶导和二阶导的解析形式。指数展开为，
\begin{equation}
	\mathbf{A}_0=\mathbf{I}+B_0(u(t))_i^{i-1} \boldsymbol{\Omega}^{\wedge}+\frac{1}{2} B_0(u(t))^2\left({ }_i^{i-1} \boldsymbol{\Omega}^{\wedge}\right)^2+\frac{1}{6} B_0(u(t))^3\left({ }_i^{i-1} \boldsymbol{\Omega}^{\wedge}\right)^3+\cdots
\end{equation}
对时间$t$求导得到，
\begin{equation}
	\begin{aligned}
		\dot{\mathbf{A}}_0&=\dot{B}_0(u(t))_i^{i-1} \boldsymbol{\Omega}^{\wedge}+\dot{B}_0(u(t)) B_0(u(t))\left({ }_i^{i-1} \boldsymbol{\Omega}^{\wedge}\right)^2+\frac{1}{2} \dot{B}_0(u(t)) B_0(u(t))^2\left({ }_i^{i-1} \boldsymbol{\Omega}^{\wedge}\right)^3+\cdots \\
		&=\dot{B}_0(u(t)){ }_i^{i-1} \boldsymbol{\Omega}^{\wedge}\left(\mathbf{I}+B_0(u(t))\left({ }_i^{i-1} \boldsymbol{\Omega}^{\wedge}\right)+\frac{1}{2} \dot{B}_0(u(t)) B_0(u(t))^2\left({ }_i^{i-1} \boldsymbol{\Omega}^{\wedge}\right)^2+\cdots\right) \\
		&=\dot{B}_0(u(t))_i^{i-1} \mathbf{\Omega}^{\wedge} \mathbf{A}_0 
	\end{aligned}
\end{equation}
因此，
\begin{equation}
	\ddot{\mathbf{A}}_0=\dot{B}_0(u(t))_i^{i-1} \boldsymbol{\Omega}^{\wedge} \dot{\mathbf{A}}_0+\ddot{B}_0(u(t))_i^{i-1} \boldsymbol{\Omega}^{\wedge} \mathbf{A}_0
\end{equation}
其中，根据公式(\ref{equ:bspline-basis})，$\tilde{\mathbf{B}}(u(t))$对时间$t$求导得到，
\begin{equation}
	\begin{aligned}
		& \dot{\mathbf{B}}(u(t))=\frac{1}{3 !}\left[\begin{array}{llll}
			0 & \left(3-6 u+3 u^2\right) & \left(3+6 u-6 u^2\right) & 3 u^2
		\end{array}\right]_{1 \times 4} \times \frac{1}{\Delta t} \\
		& \ddot{\mathbf{B}}(u(t))=\frac{1}{3 !}\left[\begin{array}{llll}
			0 & (-6+6 u) & (6-12 u) & 6 u
		\end{array}\right]_{1 \times 4} \times \frac{1}{\Delta t^2}
	\end{aligned}
\end{equation}
对$\mathbf{A}_i$求一阶导、二阶导也有类似的结果。综上，对位姿的一阶导和二阶导为，
\begin{equation}
	\begin{aligned}
		{ }_s^w \dot{\mathbf{T}}(u(t))={ }_{i-1}^w \mathbf{T}\left(\dot{\mathbf{A}}_0 \mathbf{A}_1 \mathbf{A}_2+\mathbf{A}_0 \dot{\mathbf{A}}_1 \mathbf{A}_2\right. & \left.+\mathbf{A}_0 \mathbf{A}_1 \dot{\mathbf{A}}_2\right) \\
		{ }_s^w \ddot{\mathbf{T}}(u(t))={ }_{i-1}^w \mathbf{T}\left(\ddot{\mathbf{A}_0} \mathbf{A}_1 \mathbf{A}_2+\mathbf{A}_0 \ddot{\mathbf{A}_1} \mathbf{A}_2\right. & +\mathbf{A}_0 \mathbf{A}_1 \ddot{\mathbf{A}}_2 \\
		& \left.+2 \dot{\mathbf{A}}_0 \dot{\mathbf{A}}_1 \mathbf{A}_2+2 \mathbf{A}_0 \dot{\mathbf{A}}_1 \dot{\mathbf{A}}_2+2 \dot{\mathbf{A}}_0 \mathbf{A}_1 \dot{\mathbf{A}}_2\right)
	\end{aligned}
\end{equation}
其中，
\begin{equation}
	\begin{aligned}
		{ }_i^{i-1} \boldsymbol{\Omega} & =\log \left({ }_{i-1}^w \mathbf{T}^{-1} \underset{i}{w} \mathbf{T}\right) \\
		\mathbf{A}_j & =\exp \left(B_j\left(u(t){ }_{i+j}^{i-1+j} \mathbf{\Omega}\right)\right. \\
		\dot{\mathbf{A}}_j & =\dot{B}_j(u(t))_{i+j}^{i-1+j} \mathbf{\Omega}^{\wedge} \mathbf{A}_j \\
		\ddot{\mathbf{A}}_j & =\dot{B}_j(u(t))_{i+j}^{i-1+j} \mathbf{\Omega}^{\wedge} \dot{\mathbf{A}}_j+\ddot{B}_j(u(t))_{i+j}^{i-1+j} \mathbf{\Omega}^{\wedge} \mathbf{A}_j \\
		B_0(u(t)) & =\frac{1}{3 !}\left(5+3 u-3 u^2+u^3\right) \\
		B_1(u(t)) & =\frac{1}{3 !}\left(1+3 u+3 u^2-2 u^3\right) \\
		B_2(u(t)) & =\frac{1}{3 !}\left(u^3\right) \\
		\dot{B}_0(u(t)) & =\frac{1}{3 !} \frac{1}{\Delta t}\left(3-6 u+3 u^2\right) \\
		\dot{B}_1(u(t)) & =\frac{1}{3 !} \frac{1}{\Delta t}\left(3+6 u-6 u^2\right) \\
		\dot{B}_2(u(t)) & =\frac{1}{3 !} \frac{1}{\Delta t}\left(3 u^2\right) \\
		\ddot{B}_0(u(t)) & =\frac{1}{3 !} \frac{1}{\Delta t^2}(-6+6 u) \\
		\ddot{B}_1(u(t)) & =\frac{1}{3 !} \frac{1}{\Delta t^2}(6-12 u) \\
		\ddot{B}_2(u(t)) & =\frac{1}{3 !} \frac{1}{\Delta t^2}(6 u)
	\end{aligned}
\end{equation}
%
%\begin{equation}
%	\mathbf{T}(t)=\overline{\mathbf{T}}_{i-1} \prod_{j=1}^{k-1} \operatorname{Exp}\left(b_j(u(t)) \boldsymbol{\Omega}_{i+j-1}\right)
%\end{equation}
%其中，$u(t)=\left(t-t_i\right) / \Delta t \in[0,1)$，$t \in\left[t_i, t_{i+1}\right)$并决定索引$i$。
%\begin{equation}
%	b(u)=\mathbf{C}\left[\begin{array}{lllll}
%		1 & u & u^2 & \cdots & u^{k-1}
%	\end{array}\right]^{\top}
%\end{equation}
%$\mathbf{C} \in \mathbb{R}^{k \times k}$是一个常值矩阵.
%\begin{equation}
%	\boldsymbol{\Omega}_i=\operatorname{Log} \left(\overline{\mathbf{T}}_{i-1}^{-1} \overline{\mathbf{T}}_i\right)
%\end{equation}
%$\left\{\overline{\mathbf{T}}_l\right\}_{l=\{0, \ldots, M\}}, \overline{\mathbf{T}}_l \in \mathrm{SE}(3)$是样条的控制点，表示位姿。变换$\operatorname{Exp}:\mathbb{R}^6 \rightarrow \mathrm{SE}(3)$，即将6维向量转成位姿矩阵。其逆变换为$\operatorname{Log}:\mathrm{SE}(3) \rightarrow \mathbb{R}^6$，即将位姿矩阵转成6维向量。

\subsection{非线性优化}
\subsubsection{因子图}

\subsubsection{求解}





















