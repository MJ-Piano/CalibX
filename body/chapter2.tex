\section{相机标定}
\subsection{相机模型}

\subsubsection{普通相机}
普通相机相机模型是简化的OpenCV的针孔相机模型\cite{opencvfisheye}。以下以pinhole-brwon模型为例。
\begin{itemize}
	\item \textbf{正向模型}
\end{itemize}
假设相机坐标系下的三维点$\mathbf{p}=(x,y,z)^T$, 点$\mathbf{p}$转到归一化焦平面，
\begin{equation}
x'=x/z, y'=y/z
\end{equation}
记三维点$\mathbf{p'}=(x',y',1)^T$。对$\mathbf{p'}$加畸变,
\begin{equation}\label{equ:pinhole-add-dist}
\left\{
\begin{array}{lr}
r^2 = x'^2+y'^2 \\
x_d = x'*(1+k_1*r^2+k_2*r^4+k_3*r^6)+2*p_1x'*y'+p_2*(r^2+2*x'^2) \\
y_d = y'*(1+k_1*r^2+k_2*r^4+k_3*r^6)+2*p_2x'*y'+p_1*(r^2+2*y'^2)
\end{array}
\right.
\end{equation}
其中$\mathbf{p}_d=(x_d,y_d)^T$为畸变点。转化到图像坐标，
\begin{equation}
\left\{
\begin{array}{lr}
u=f_x*x_d+c_x \\
v=f_y*y_d+c_y 
\end{array}
\right.
\end{equation}
其中，$f_x,f_y$为焦距，$c_x,c_y$为光心。
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{itemize}
	\item \textbf{反向模型}
\end{itemize}
将图像坐标转到相机坐标系归一化焦平面，
\begin{equation}
\left\{
\begin{array}{lr}
x_d=(u-c_x)/f_x \\
y_d=(v-c_y)/f_y 
\end{array}
\right.
\end{equation}
对点$\mathbf{p}_d=(x_d,y_d)^T$去畸变，采用迭代的方式计算$p'$，如算法\ref{alg:pinhole-remove-dist}所示。\\
\SetKwRepeat{Do}{do}{while}%
\begin{algorithm}[H]
	\caption{pinhole-brown模型去畸变}%算法名字
	\label{alg:pinhole-remove-dist}
	\LinesNumbered %要求显示行号
	\KwIn{畸变点$\mathbf{p}_d=(x_d,y_d)^T$,畸变系数$k_1, k_2, k_3, p_1, p_2$}%输入参数
	\KwOut{去畸变点$\mathbf{p'}=(x',y')^T$}%输出
	设置阈值$\epsilon$，设置初始化去畸变点$\mathbf{p'}=\mathbf{p}_d$，设置迭代次数$N$\; %\;用于换行
%	$\Delta x_d = x'*(k_1*r^2+k_2*r^4+k_3*r^6)+2*p_1x'*y'+p_2*(r^2+2*x'^2)$ \;
%	$\Delta y_d = y'*(k_1*r^2+k_2*r^4+k_3*r^6)+2*p_2x'*y'+p_1*(r^2+2*y'^2)$ \;
%	\While{$\left\| \mathbf{p'}+(\Delta x_d,\Delta y_d)^T-\mathbf{p}_d\right\|_1>\epsilon$ and \mbox{迭代次数小于$N$}}{
%		$\mathbf{p'} = \mathbf{p}_d-(\Delta x_d,\Delta y_d)^T$\;
%		$\Delta x_d = x'*(k_1*r^2+k_2*r^4+k_3*r^6)+2*p_1x'*y'+p_2*(r^2+2*x'^2)$ \;
%		$\Delta y_d = y'*(k_1*r^2+k_2*r^4+k_3*r^6)+2*p_2x'*y'+p_1*(r^2+2*y'^2)$ \;
%	}
	\Do{$\left\| \mathbf{p'}+(\Delta x_d,\Delta y_d)^T-\mathbf{p}_d\right\|_1>\epsilon$ and \mbox{迭代次数小于$N$}}{
		$\Delta x_d = x'*(k_1*r^2+k_2*r^4+k_3*r^6)+2*p_1x'*y'+p_2*(r^2+2*x'^2)$ \;
		$\Delta y_d = y'*(k_1*r^2+k_2*r^4+k_3*r^6)+2*p_2x'*y'+p_1*(r^2+2*y'^2)$ \;
		$\mathbf{p'} = \mathbf{p}_d-(\Delta x_d,\Delta y_d)^T$\;
	}
\end{algorithm}
pinhole-brown模型去掉$k_3$，即为pinhole-radtan模型。
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{鱼眼相机}
Calib-X支持的广角/鱼眼相机模型为pinhole-equidistant。该模型源自Kannala-Brandt Camera Model\cite{kannala2006generic}（简称为\textbf{KB}模型）。
\begin{enumerate}[(1)]
	\item \textbf{KB正向模型}
\end{enumerate}

\begin{itemize}
	\item \textbf{投影模型}
\end{itemize}
假设$\theta$ 是入射光线和光轴的夹角，$r$是主点到像点的距离。满足，
\begin{equation}
r(\theta)=k_{1} \theta+k_{2} \theta^{3}+k_{3} \theta^{5}+k_{4} \theta^{7}+k_{5} \theta^{9}+\ldots
\end{equation}
假设$\Phi=(\theta, \varphi)^{\top}$是用来描述入射光线的方向的向量，则
\begin{equation}
\mathbf{x}=
\left(\begin{array}{l}
x \\
y
\end{array}\right)=r(\theta)\left(\begin{array}{c}
\cos \varphi \\
\sin \varphi
\end{array}\right)=\mathcal{F}(\Phi)
\end{equation}
如图\ref{kb model}所示。
\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\textwidth]{figure/cp2/ds}
	\caption{\textbf{KB}模型。$X_c-Y_c-Z_c$表示相机坐标系，$P$为相机坐标系下的三维点，$x,y$表示图像坐标系}
	\label{kb model}
\end{figure}
\begin{itemize}
	\item \textbf{畸变模型}
\end{itemize}
径向畸变模型，
\begin{equation}\begin{array}{l}
\Delta_{\mathrm{r}}(\theta, \varphi)= \\
\left(l_{1} \theta+l_{2} \theta^{3}+l_{3} \theta^{5}\right)\left(i_{1} \cos \varphi+i_{2} \sin \varphi+i_{3} \cos 2 \varphi+i_{4} \sin 2 \varphi\right)
\end{array}\end{equation}
切向畸变模型，
\begin{equation}\begin{array}{l}
\Delta_{\mathrm{t}}(\theta, \varphi)= \\
\left(m_{1} \theta+m_{2} \theta^{3}+m_{3} \theta^{5}\right)\left(j_{1} \cos \varphi+j_{2} \sin \varphi+j_{3} \cos 2 \varphi+j_{4} \sin 2 \varphi\right)
\end{array}\end{equation}
畸变模型共包含14个变量。
\begin{itemize}
	\item \textbf{完整模型} 
\end{itemize}
\begin{equation}\label{equ:equi-distort}
\begin{aligned}
\mathbf{x}_{\mathrm{d}}&=\mathbf{x}+\mathbf{s} \\
&=
r(\theta) \mathbf{u}_{r}(\varphi)+\Delta_{r}(\theta, \varphi) \mathbf{u}_{r}(\varphi)+\Delta_{t}(\theta, \varphi) \mathbf{u}_{\varphi}(\varphi) \\
&=\mathcal{D}\left(\mathbf{x}_{\mathrm{d}}\right)
\end{aligned}
\end{equation}
其中，$\mathbf{u}_{r}(\varphi)=(\cos \varphi, \sin \varphi)^{\top}$和$\mathbf{u}_{\varphi}(\varphi)$是径向和切向方向的单位向量,
\begin{equation}\mathbf{s}=\mathcal{S}(\Phi)=\Delta_{r}(\theta, \varphi) \mathbf{u}_{r}(\varphi)+\Delta_{t}(\theta, \varphi) \mathbf{u}_{\varphi}(\varphi)\end{equation}
像素坐标为，
\begin{equation}\label{equ:equi-projection}
\mathbf{m}=
\left(\begin{array}{l}
u \\
v
\end{array}\right)=
\left[\begin{array}{cc}
m_{u} & 0 \\
0 & m_{v}
\end{array}\right]
\left(\begin{array}{l}
x_{\mathrm{d}} \\
y_{\mathrm{d}}
\end{array}\right)+\left(\begin{array}{c}
u_{0} \\
v_{0}
\end{array}\right)=\mathcal{A}\left(\mathrm{x}_{\mathrm{d}}\right)
\end{equation}
其中，$m_{u}$和$m_{v}$是水平和垂直方向单位距离包含的像素数。结合公式\ref{equ:equi-distort}和\ref{equ:equi-projection}，记完整的正向相机模型为，
\begin{equation}
\mathbf{m}=\mathcal{P}_{\mathrm{c}}(\Phi)=\mathcal{A} \circ \mathcal{D} \circ \mathcal{F}
\end{equation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{enumerate}[(2)]
	\item \textbf{KB反向模型}
\end{enumerate}
\begin{equation}
\Phi=\mathcal{P}_{\mathrm{c}}^{-1}(\mathbf{m})
=\mathcal{F}^{-1} \circ \mathcal{D}^{-1} \circ \mathcal{A}^{-1}
\end{equation}
其中，$\mathcal{F}^{-1}$和$\mathcal{A}^{-1}$比较容易得到解析解。难点在于计算$\mathcal{D}^{-1}$，即计算$\mathbf{s}$。$\mathbf{s}$在$\mathbf{x}_{\mathrm{d}}$附近用一阶泰勒近似，
\begin{equation}\label{equ:s}
\begin{aligned}
\mathbf{s} & \simeq\left(\mathcal{S} \circ \mathcal{F}^{-1}\right)\left(\mathbf{x}_{\mathbf{d}}\right)+\frac{\partial\left(\mathcal{S} \circ \mathcal{F}^{-1}\right)}{\partial \mathbf{x}}\left(\mathbf{x}_{\mathbf{d}}\right)\left(\mathbf{x}-\mathbf{x}_{\mathbf{d}}\right) \\
&=\mathcal{S}\left(\Phi_{\mathrm{d}}\right)-\frac{\partial \mathcal{S}}{\partial \Phi}\left(\frac{\partial \mathcal{F}}{\partial \Phi}\left(\Phi_{\mathrm{d}}\right)\right)^{-1} \mathbf{s}
\end{aligned}\end{equation}
其中，$\Phi_{\mathrm{d}}=\mathcal{F}^{-1}\left(\mathbf{x}_{\mathrm{d}}\right)$。
整理公式\ref{equ:s},
\begin{equation}
\mathcal{S}\left(\Phi_{\mathrm{d}}\right)= \left(I + \frac{\partial \mathcal{S}}{\partial \Phi}\left(\frac{\partial \mathcal{F}}{\partial \Phi}\left(\Phi_{\mathrm{d}}\right)\right)^{-1}\right) \mathbf{s}
\end{equation}
由此可得，
\begin{equation}\mathbf{s} \simeq\left(I+\frac{\partial \mathcal{S}}{\partial \Phi}\left(\Phi_{\mathrm{d}}\right)\left(\frac{\partial \mathcal{F}}{\partial \Phi}\left(\Phi_{\mathrm{d}}\right)\right)^{-1}\right)^{-1} \mathcal{S}\left(\Phi_{\mathrm{d}}\right)\end{equation}
因此，
\begin{equation}\begin{array}{l}
\mathcal{D}^{-1}\left(\mathbf{x}_{\mathrm{d}}\right) \simeq \mathbf{x}_{\mathrm{d}}- \\
\left(I+\left(\frac{\partial \mathcal{S}}{\partial \Phi} \circ \mathcal{F}^{-1}\right)\left(\mathbf{x}_{\mathrm{d}}\right)\left(\left(\frac{\partial \mathcal{F}}{\partial \Phi} \circ \mathcal{F}^{-1}\right)\left(\mathbf{x}_{\mathrm{d}}\right)\right)^{-1}\right)^{-1}\left(\mathcal{S} \circ \mathcal{F}^{-1}\right)\left(\mathbf{x}_{\mathrm{d}}\right)
\end{array}\end{equation}
\begin{enumerate}[(3)]
	\item \textbf{CalibX中使用的pinhole-equidistant模型}
\end{enumerate}
CalibX中使用的pinhole-equidistant模型其实与OpenCV中使用的fish-eye模型\cite{opencvfisheye}是一样的。
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{itemize}
	\item \textbf{正向模型}
\end{itemize}
假设相机坐标系下的三维点$\mathbf{p}=(x,y,z)^T$, 点$\mathbf{p}$转到归一化焦平面，
\begin{equation}
	x'=x/z, y'=y/z
\end{equation}
记三维点$\mathbf{p'}=(x',y',1)^T$。对$\mathbf{p'}$加畸变,
\begin{equation}\label{equ:equi-add-disst}
\left\{
\begin{array}{lr}
r=\sqrt{x'*x'+y'*y'}   \\
\theta = atan(r) \\
\theta_d = \theta\left(1+k_1*\theta^2+k_2*\theta^4+k_3*\theta^6+k_4*\theta^8\right) \\
x_d = \theta_d*x'/r, y_d = \theta_d*y'/r  
\end{array}
\right.
\end{equation}
其中$\mathbf{p}_d=(x_d,y_d)^T$为畸变点。转化到图像坐标，
\begin{equation}
\left\{
\begin{array}{lr}
u=f_x*x_d+c_x \\
v=f_y*y_d+c_y 
\end{array}
\right.
\end{equation}
其中，$f_x,f_y$为焦距，$c_x,c_y$为光心。
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{itemize}
	\item \textbf{反向模型}
\end{itemize}
将图像坐标转到相机坐标系归一化焦平面，
\begin{equation}
\left\{
\begin{array}{lr}
x_d=(u-c_x)/f_x \\
y_d=(v-c_y)/f_y 
\end{array}
\right.
\end{equation}
根据公式\ref{equ:equi-add-disst}，
\begin{equation}
\left\{
\begin{array}{lr}
r = tan(\theta) \\
\theta_d = \sqrt{x_d^2+y_d^2} \\
x' = r*x_d/\theta_d, y' = r*y_d/\theta_d
\end{array}
\right.
\end{equation}
其中，$\theta_d$的推导如下，
\begin{equation}
\begin{aligned}
\theta_d &= x_d * r / x' =  y_d * r /y' \\
\theta_d^2 &= \frac{r^2*x_d^2}{x'^2} = \frac{r^2*y_d^2}{y'^2} \mbox{（两边平方）}\\
&= \frac{r^2(x_d^2+y_d^2)}{x'^2+y'^2} \mbox{（等比定理）}\\
&=x_d^2+y_d^2 \mbox{（利用$r=\sqrt{x'^2+y'^2}$化简）}\\
\theta_d &= \sqrt{x_d^2+y_d^2}
\end{aligned}
\end{equation}
对点$\mathbf{p}_d=(x_d,y_d)^T$去畸变，采用迭代的方式计算$\theta$，如算法\ref{alg:equi-remove-dist}所示。\\
\begin{algorithm}[H]
	\caption{pinhole-equidistant模型去畸变}%算法名字
	\label{alg:equi-remove-dist}
	\LinesNumbered %要求显示行号
	\KwIn{畸变点$\mathbf{p}_d=(x_d,y_d)^T$,畸变系数$k_1, k_2, k_3, k_4$}%输入参数
	\KwOut{去畸变点$\mathbf{p'}$}%输出
	设置阈值$\epsilon$，设置初始化尺度$scale=1$，设置迭代次数$N$\; %\;用于换行
	$\theta_d=\sqrt{x_d*x_d+y_d*y_d}$ \;
	$\theta = \theta_d$ \;
	\If{$\theta_d>\epsilon$}{
		$\theta=\theta_d$\;
		\For{$j=0; j<N; ++j$}{
			$\theta=\theta_d/\left(1+k_1*\theta^2+k_2*\theta^4+k_3*\theta^6+k_4*\theta^8\right)$\;		
		}
	}
	$scale = tan(\theta)/\theta_d$ \;
	$\mathbf{p'}=\mathbf{p}_d*scale$
\end{algorithm}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{单相机标定}
\subsubsection{单标定板单相机标定}
假设$\mathbf{m}_j=(X,Y,Z)^T, j=1...M$为世界坐标系下的三维点，$\mathbf{T}_i=\{\mathbf{R}_i,\mathbf{t}_i\}$为$i$时刻世界坐标系到相机坐标系的转换矩阵，$\mathbf{m}_{ij}$为特征点$\mathbf{m}_j$在$i$时刻的观测， $\mathbf{K}$为相机内参矩阵。相机标定通过最小化重投影误差来实现。首先，将点$\mathbf{m}_j$转到相机坐标系，
\begin{equation}
	\mathbf{p}_j = \mathbf{R}_i*\mathbf{m}_j+\mathbf{t}_i
\end{equation}
利用相机的正向模型，得到点$\mathbf{p}_j$在$i$时刻的观测，即图像坐标，
\begin{equation}
	\hat{\mathbf{m}}_{ij} = \pi(\mathbf{R}_i,\mathbf{t}_i, \mathbf{m}_j)
\end{equation}
重投影误差为，
\begin{equation}
	\mathbf{r}_{ij}=\sigma_{ij}*(\hat{\mathbf{m}}_{ij} - \mathbf{m}_{ij})
\end{equation}
其中，$\sigma_{ij}$为观测协方差的逆。
\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{figure/cp2/calibrate_camera}
	\caption{相机标定流程图}
	\label{camera_calibration_framework}
\end{figure}
总的优化目标函数定义为，
\begin{equation}
\{\mathbf{R}^*,\mathbf{t}^*, \mathbf{m}^*, \mathbf{K}^*\}=\mathop{\arg\min}_{\mathbf{R},\mathbf{t}, \mathbf{m}, \mathbf{K}} \ \ \sum_{i=1}^{N} \sum_{j=1}^{M} \| \mathbf{r}_{ij}\|.
\end{equation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{多标定板单相机标定}
对于使用多标定板的情形，需要选择一块标定板作为参考并且以参考标定板的坐标系作为世界坐标系。记参考标定板的ID为$0$，第$b$个标定板到参考标定板的转换矩阵为$\mathbf{T}_{0b}=\{\mathbf{R}_{0b},\mathbf{t}_{0b}\}$。显然，$\mathbf{T}_{00}=\{\mathbf{I}_3,(0,0,0)^T\}$。假设$\mathbf{m}_{bj}=(X,Y,Z)^T, j=1...M_b$为$b$标定板所在坐标系下的三维点，则把$\mathbf{m}_{bj}$转换到世界坐标系为，
\begin{equation}
\mathbf{p}_{bj} = \mathbf{R}_{0b}*\mathbf{m}_{bj}+\mathbf{t}_{0b}
\end{equation}
\subsection{多相机标定}
\subsubsection{重叠视场多相机标定}
相机之间的连接关系是通过无向有权图来表示的，图的顶点表示相机。假设所有相机帧率相同并且都是在相同的时刻触发曝光。如果两个相机在某一时刻看到相同的特征点（简称为共视点），则该两个相机在图中有边连接。所有时刻共视点的数目之和作为两个相机之间边的权重。重叠视场的假设是，对于任意两个相机存在路径可达。根据无向有权图求解相机最优路径（optimal path）的见算法\ref{alg:overlap-cams-graph}。\\
\begin{algorithm}[H]
	\caption{重叠视场多相机标定相机链条构建}%算法名字
	\label{alg:overlap-cams-graph}
	\LinesNumbered %要求显示行号
	\KwIn{无向有权图$\mathbf{G}=\{\mathbf{V},\mathbf{E}\}$，假设有$C$个顶点，即$C$个相机}%输入参数
	\KwOut{相机最优路径（optimal path）}%输出
	将$\mathbf{E}$中的权重取倒数\; %\;用于换行
	利用Dijkstra算法求出顶点$V_0$到任意一个顶点的 $V_c$的最短路径 \;
	利用所有最短路径和顶点构成新的图$\mathbf{G}'$ \;
	\For{$j=0; j<C-1; ++j$}{
		利用Dijkstra算法求出顶点$V_j$到任意一个顶点的 $V_{j+1}$的最短路径$P_j$\;	
		$P_j$添加到optimal path	
	}
\end{algorithm}
根据最优路径，即可构建相机链条（baselines）。相机链条总是相机0$\rightarrow$相机1$\rightarrow$相机2$\rightarrow\dots\rightarrow$相机C-1。记baselines为$\mathbf{B}=\{\mathbf{B}_0,\mathbf{B}_1,...,\mathbf{B}_{C-1}\}$，其中$\mathbf{B}_c=\{\mathbf{R}_c,\mathbf{t}_c\}$表示相机c到相机c+1的转换矩阵。实际上，仅优化相机0的外参$\mathbf{T}_0$。通过$\mathbf{T}_0$和$\mathbf{B}$可以求解任一相机的外参，即$i$时刻，世界坐标系到相机c的相机坐标系的转换矩阵$\mathbf{T}_{ci}$为，
\begin{equation}
	\mathbf{T}_{ci}=\mathbf{B}_{c-1}*\dots*\mathbf{B}_0*\mathbf{T}_{0i}
\end{equation}
\subsubsection{无重叠视场多相机标定}
无重叠视场多相机标定使用手眼标定方法初始化相机链条，即假设相机c的外参为$\mathbf{T}_c=\{\mathbf{T}_{c0},\mathbf{T}_{c1}\dots\}$，相机a的外参为$\mathbf{T}_a=\{\mathbf{T}_{a0},\mathbf{T}_{a1}\dots\}$。手眼标定旨在寻找一个最优的转换矩阵$\mathbf{B}_{ca}$，使得$\mathbf{T}_a$和$\mathbf{T}_c$对齐误差最小。需要注意的是，手眼标定要求$\mathbf{T}_a$和$\mathbf{T}_c$外参数目一致。对于使用OpenCV进行单板单相机标定中，标定板并不能保证任意时刻都能看到。因此，在使用OpenCV进行单板单相机标定后，再使用所有标定板的观测，重新计算相机外参以保证所有时刻的相机外参都能求解出来。实际上，相机链条总是相机0$\rightarrow$相机1$\rightarrow$相机2$\rightarrow\dots\rightarrow$相机C-1。记baselines为$\mathbf{B}=\{\mathbf{B}_0,\mathbf{B}_1,...,\mathbf{B}_{C-1}\}$，其中$\mathbf{B}_c=\{\mathbf{R}_c,\mathbf{t}_c\}$表示相机c到相机c+1的转换矩阵。同样的，仅优化相机0的外参$\mathbf{T}_0$。